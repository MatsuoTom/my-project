# 戦略ランキング機能の動作確認ガイド

## 修正内容サマリー

### 1. 問題の特定
- `WithdrawalOptimizer` クラスに `analyze_all_strategies` メソッドが存在しなかった
- `calculate_policy_value` メソッドの複利計算ロジックが不完全だった
- 関数内での重複インポートによる `ModuleNotFoundError`

### 2. 実施した修正

#### A. `withdrawal_optimizer.py` に以下のメソッドを追加
- **`analyze_all_strategies()`**: 複数戦略（部分解約・全解約・乗り換え）を一括分析してランキング化
- **`_calculate_partial_withdrawal_benefit()`**: 部分解約戦略の純利益計算
- **`_calculate_switch_benefit()`**: 乗り換え戦略の純利益計算

#### B. `calculate_policy_value()` メソッドの修正
- 年間保険料の複利計算ループを正しく実装
- 解約返戻金の計算精度を向上

#### C. `streamlit_app.py` の修正
- 関数内の重複インポート文を削除
- `_show_detailed_plan_analysis()` 関数の重複定義を解消

## 動作確認手順

### ステップ 1: Streamlit アプリの起動

```powershell
.venv\Scripts\Activate.ps1
streamlit run life_insurance\ui\streamlit_app.py
```

ブラウザで自動的に開きます（または `http://localhost:8504` にアクセス）

### ステップ 2: 詳細分析（戦略ランキング）画面を開く

1. サイドバーの「分析メニューを選択」で **「詳細分析（戦略ランキング）」** を選択
2. 画面が切り替わります

### ステップ 3: パラメータ設定

**左カラム「📋 プラン設定」:**
- 保険プランタイプ: 旧一般生命保険料控除
- 月払保険料: 9,000円
- 年利: 1.25%

**右カラム「🧮 税務情報」:**
- 課税所得: 600万円
- 契約期間: 20年
- 引き出し予定年数: 15年

### ステップ 4: 詳細分析を実行

1. **「📊 詳細分析を実行」** ボタンをクリック
2. 「分析を実行中...」メッセージが表示される
3. 数秒後、**「🏆 戦略ランキング（±5年±50％範囲）」** テーブルが表示される

### ステップ 5: 結果の確認

**表示されるランキング表の列:**
- **ランク**: 純利益順のランキング
- **戦略タイプ**: 部分解約 / 全解約 / 乗り換え
- **戦略名**: 具体的な戦略内容
- **純利益(円)**: 計算された純利益
- **間隔(年)**: 解約・乗り換えの間隔
- **解約割合**: 解約する割合
- **パラメータ**: 戦略パラメータ詳細

**期待される結果:**
- Top 20の戦略がランキング形式で表示される
- 純利益がプラス値で表示される（正しい計算結果）
- 部分解約戦略が上位にランクインする傾向

## 単体テスト

`analyze_all_strategies` メソッドの単体テストも用意しています：

```powershell
python test_analyze_all_strategies.py
```

**期待される出力:**
```
=== analyze_all_strategies テスト開始 ===
...
✅ 実行成功！

戦略数: 116

Top 10 戦略ランキング:
 ランク 戦略タイプ                戦略名       純利益(円)  ...
   1  部分解約 部分解約 (間隔1年, 割合91%) 2.084615e+07  ...
   ...

=== テスト完了: 成功 ✅ ===
```

## トラブルシューティング

### エラー: `ModuleNotFoundError: No module named 'life_insurance'`
**原因**: インポートパスの問題  
**解決**: `streamlit_app.py` の関数内で `from life_insurance.analysis...` を使わず、ファイル先頭の import を使用

### エラー: `AttributeError: 'WithdrawalOptimizer' object has no attribute 'analyze_all_strategies'`
**原因**: メソッドが未実装  
**解決**: `withdrawal_optimizer.py` に `analyze_all_strategies` メソッドを追加（本修正で対応済み）

### 純利益がすべてマイナスになる
**原因**: `calculate_policy_value` の複利計算ロジックが不完全  
**解決**: 年間保険料の複利計算ループを正しく実装（本修正で対応済み）

### ボタンをクリックしても何も表示されない
**原因**: 
1. 関数の重複定義やUI連携の不具合
2. パラメータ範囲が不正

**解決**:
1. `_show_detailed_plan_analysis` の重複定義を削除（本修正で対応済み）
2. パラメータ設定を確認（年数・割合が有効範囲内か）

## 技術詳細

### 戦略パラメータの自動生成

**基本設定:**
- 引き出し予定年数: 15年
- 基準解約割合: 50%

**自動生成範囲:**
- **年数範囲**: 引き出し予定年数 ±5年 → [10, 11, 12, ..., 20]年
- **割合範囲**: 基準割合 ±50% → [1%, 11%, 21%, ..., 91%]
- **部分解約間隔**: [1, 2, 3, 4, 5]年
- **乗り換え手数料**: [1%, 2%, 3%, 4%, 5%]

**戦略数の計算:**
- 部分解約: 間隔5種 × 割合10種 = 50戦略
- 全解約: 年数11種 = 11戦略
- 乗り換え: 年数11種 × 手数料5種 = 55戦略
- **合計**: 116戦略

### 計算ロジック

#### 部分解約戦略
1. 毎年の節税効果を累積
2. 指定間隔ごとに解約返戻金の一部を引き出し
3. 最終年に残高を全額回収
4. 純利益 = 総引き出し額 + 節税効果 - 払込保険料

#### 全解約戦略
1. 指定年まで保険を継続
2. 累積節税効果を計算
3. 解約返戻金を一括受取
4. 一時所得税を考慮
5. 純利益 = 解約返戻金 + 節税効果 - 払込保険料 - 解約時所得税

#### 乗り換え戦略
1. 指定年で既存保険を解約
2. 乗り換え手数料を差し引き
3. 新商品で残り期間を運用
4. 純利益 = 乗り換え後価値 + 総節税効果 - 払込保険料

## ファイル一覧

### 修正済みファイル
- `life_insurance/analysis/withdrawal_optimizer.py`: 戦略分析メソッド追加・修正
- `life_insurance/ui/streamlit_app.py`: UI連携修正・重複削除

### 新規作成ファイル
- `test_analyze_all_strategies.py`: 単体テストスクリプト
- `VERIFICATION_GUIDE.md`: 本ガイド

## まとめ

✅ **修正完了項目:**
1. `analyze_all_strategies` メソッドの実装
2. 複利計算ロジックの修正
3. ModuleNotFoundError の解消
4. UI連携の修正

✅ **動作確認済み:**
- 単体テスト: 116戦略を正常に分析、純利益がプラス値
- Streamlit UI: 「📊 詳細分析を実行」ボタンでランキング表が正しく表示

🎉 **戦略ランキング機能は完全に動作しています！**
