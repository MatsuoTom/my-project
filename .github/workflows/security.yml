# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã¨ã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯

name: Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯Žé€±æœˆæ›œæ—¥ åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«ã‚¹ã‚­ãƒ£ãƒ³
    - cron: '0 0 * * 1'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

jobs:
  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
    
    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        pip install -r requirements.txt || echo "requirements.txt not found"
    
    - name: Safety - ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
      continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š
      run: |
        echo "ðŸ” ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        safety check --json > safety-report.json || true
        safety check || echo "è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    
    - name: Bandit - ã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      continue-on-error: true  # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶š
      run: |
        echo "ðŸ” ã‚³ãƒ¼ãƒ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        bandit -r life_insurance pension_calc investment_simulation common \
          -f json -o bandit-report.json || true
        bandit -r life_insurance pension_calc investment_simulation common \
          --severity-level medium || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    
    - name: ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json
        retention-days: 30
    
    - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒžãƒªãƒ¼
      if: always()
      run: |
        echo "## ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f safety-report.json ]; then
          echo "### Safetyï¼ˆä¾å­˜é–¢ä¿‚ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat safety-report.json | jq -r '.vulnerabilities | length' > vuln_count.txt || echo "0" > vuln_count.txt
          VULN_COUNT=$(cat vuln_count.txt)
          echo "æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§: ${VULN_COUNT}ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f bandit-report.json ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Banditï¼ˆã‚³ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          cat bandit-report.json | jq -r '.results | length' > issues_count.txt || echo "0" > issues_count.txt
          ISSUES_COUNT=$(cat issues_count.txt)
          echo "æ¤œå‡ºã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: ${ISSUES_COUNT}ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ã¯Artifactsã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
