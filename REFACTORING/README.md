# 🔄 my-project リファクタリングプロジェクト

**開始日:** 2025年10月25日  
**想定期間:** 8-12週間  
**目的:** コードの冗長性を削減し、可読性・保守性・拡張性を向上させる

---

## 📊 現状分析

### 問題点
- ✗ 総コード行数: ~8,500行
- ✗ 重複コード率: ~35%
- ✗ 平均関数長: 85行
- ✗ テストカバレッジ: 45%
- ✗ 税金・控除計算が30箇所以上で重複
- ✗ 保険価値計算ロジックが複数バージョン存在
- ✗ UI入力処理とプロット生成が散在

### 目標
- ✓ 総コード行数: ~6,000行（-29%）
- ✓ 重複コード率: ~10%（-71%）
- ✓ 平均関数長: 45行（-47%）
- ✓ テストカバレッジ: 75%（+67%）
- ✓ 新機能追加工数: 5日 → 2日（-60%）
- ✓ バグ修正工数: 3日 → 1日（-67%）

---

## 🎯 4段階のフェーズ構成

### Phase 1: 即効性の高いリファクタリング（1-2週間）
**優先度: 🔴 最高**

- [ ] 税金ヘルパーモジュール作成
- [ ] 既存コードの置換（30箇所以上）
- [ ] テスト追加

**期待効果:** -500行、バグ修正工数-70%

### Phase 2: コア計算ロジックの統合（2-3週間）
**優先度: 🟠 高**

- [ ] 保険計算エンジン作成
- [ ] データクラス導入
- [ ] 重複関数の統合
- [ ] 包括的テスト追加

**期待効果:** -800行、計算精度向上

### Phase 3: 共通基盤構築（3-4週間）
**優先度: 🟡 中**

- [ ] common/ディレクトリ構造作成
- [ ] 共通計算ロジック抽出
- [ ] ミックスインクラス実装
- [ ] 両モジュールでの利用

**期待効果:** プロジェクト全体の一貫性向上

### Phase 4: UI層の最適化（1-2週間）
**優先度: 🟢 低**

- [ ] UI共通コンポーネント作成
- [ ] 可視化ヘルパー作成
- [ ] 既存UI関数のリファクタリング

**期待効果:** UI一貫性・開発速度向上

---

## 📁 プロジェクト構造（リファクタリング後）

```
my-project/
├── common/                          # ✨ 新規: 共通基盤レイヤー
│   ├── __init__.py
│   ├── calculators/
│   │   ├── __init__.py
│   │   ├── base_calculator.py      # 基底計算クラス
│   │   └── tax_calculator.py       # 共通税金計算
│   ├── models/
│   │   ├── __init__.py
│   │   └── financial_plan.py       # 金融プラン基底クラス
│   └── ui/
│       ├── __init__.py
│       ├── input_components.py     # 共通入力コンポーネント
│       └── chart_builder.py        # 共通チャートビルダー
│
├── life_insurance/
│   ├── utils/                       # ✨ 新規: ユーティリティ層
│   │   ├── __init__.py
│   │   ├── tax_helpers.py          # 税金計算ヘルパー
│   │   └── visualization.py        # 可視化ヘルパー
│   ├── analysis/
│   │   ├── insurance_calculator.py # ✨ 新規: 統合計算エンジン
│   │   ├── withdrawal_optimizer.py # 🔄 リファクタ対象
│   │   └── scenario_analyzer.py    # 🔄 リファクタ対象
│   └── ui/
│       └── streamlit_app.py        # 🔄 大規模リファクタ対象
│
├── pension_calc/
│   └── ...                          # Phase 3で共通基盤を適用
│
└── REFACTORING/                     # ✨ 新規: リファクタリング管理
    ├── README.md                    # このファイル
    ├── MASTER_PLAN.md               # 詳細実装計画
    ├── PROGRESS.md                  # 進捗トラッキング
    ├── PHASE_1/                     # Phase 1専用ディレクトリ
    ├── PHASE_2/                     # Phase 2専用ディレクトリ
    ├── PHASE_3/                     # Phase 3専用ディレクトリ
    └── PHASE_4/                     # Phase 4専用ディレクトリ
```

---

## 🚀 開始手順

1. **Phase 1から開始することを強く推奨**
   - 最もリスクが低く、効果が高い
   - 他のPhaseの基盤となる

2. **各Phaseの実施前に:**
   ```bash
   # ブランチ作成（推奨）
   git checkout -b refactor/phase-1
   
   # 現在のテスト実行（ベースライン確保）
   pytest life_insurance/tests/
   ```

3. **各Phaseの実施後に:**
   ```bash
   # テスト実行
   pytest
   
   # アプリ起動確認
   streamlit run life_insurance/ui/streamlit_app.py
   
   # コミット
   git add .
   git commit -m "refactor: Phase 1 - 税金ヘルパー実装"
   ```

---

## 📝 進捗トラッキング

詳細な進捗は `PROGRESS.md` を参照してください。

### 週次レビュー（推奨）
- [ ] Week 1-2: Phase 1完了
- [ ] Week 3-5: Phase 2完了
- [ ] Week 6-9: Phase 3完了
- [ ] Week 10-11: Phase 4完了
- [ ] Week 12: 総合テスト・ドキュメント更新

---

## ⚠️ 注意事項

1. **既存機能を壊さない**
   - 各変更後に必ずテスト実行
   - UI動作確認を怠らない

2. **段階的に実施**
   - 一度に大量の変更をしない
   - 小さなコミットを積み重ねる

3. **テストファースト**
   - 新規ユーティリティには必ずテストを追加
   - 既存テストが通ることを確認

4. **ドキュメント更新**
   - 関数のdocstringを充実させる
   - 型ヒントを明示的に記述

---

## 🔗 関連ドキュメント

- [MASTER_PLAN.md](./MASTER_PLAN.md) - 詳細実装計画
- [PROGRESS.md](./PROGRESS.md) - 進捗トラッキング
- [PHASE_1/](./PHASE_1/) - Phase 1の詳細
- [PHASE_2/](./PHASE_2/) - Phase 2の詳細
- [PHASE_3/](./PHASE_3/) - Phase 3の詳細
- [PHASE_4/](./PHASE_4/) - Phase 4の詳細

---

**最終更新:** 2025年10月25日  
**次のマイルストーン:** Phase 1完了（目標: 2週間以内）
